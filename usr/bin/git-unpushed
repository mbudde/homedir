#!/bin/bash
# Michael Budde <mbudde@gmail.com>
# Show list of commits that haven't been pushed to tracking branch

read -d '' USAGE <<"EOF"
[options] [<branch>]

Options:
    -d              show committer date in the list
EOF
SUBDIRECTORY_OK=1
. "$(git --exec-path)/git-sh-setup"

while getopts "dh" opt; do
    case $opt in
        d)
            show_dates=1
            ;;
        h | \?)
            usage
            ;;
    esac
done
shift $((OPTIND-1))

if [ -n "$1" ]; then
    branch="$1"
else
    branch=$(git symbolic-ref HEAD) || die $branch
    branch=${branch#refs/heads/}
fi

remote=$(git config branch.${branch}.remote) || \
    die "fatal: No remote is configured for branch '${branch}'."

remotebranch=$(git config branch.${branch}.merge) || \
    die "No remote tracking branch is configured for branch '${branch}'."
remotebranch=${remotebranch#refs/heads/}

ncommits=$(git rev-list "${remote}/${remotebranch}.." | wc -l)
[ $ncommits -gt 1 ] && plural="s"
printf "# %d unpushed commit%s to ${remote}/${remotebranch}:\n" \
    $ncommits $plural

if [ $show_dates ]; then
    git log --oneline --format=format:"%C(yellow)%h %C(blue)%cr %Creset%s" \
        "${remote}/${remotebranch}.." "$@"
else
    git log --oneline "${remote}/${remotebranch}.." "$@"
fi
