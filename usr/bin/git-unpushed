#!/bin/bash
# Michael Budde <mbudde@gmail.com>
# Show list of commits that haven't been pushed to tracking branch

if [ "$1" = "-h" ]; then
    echo "usage: git unpushed [-d|--dates]"
    exit 129
fi

branch=$(git symbolic-ref -q HEAD 2>/dev/null | sed "s#^refs/heads/##")
if [ -z "${branch}" ]; then
    echo "Not on git branch"
    exit 1
fi
remote=$(git config branch.${branch}.remote)
if [ -z "${remote}" ]; then
    echo "No remote"
    exit 1
fi
remotebranch=$(git config branch.${branch}.merge | sed "s#^refs/heads/##")
if [ -z "${remotebranch}" ]; then
    echo "No tracking branch setup"
    exit 1
fi

echo "# Unpushed commits to ${remote}/${remotebranch}:"
if [ "$1" = "-d" -o "$1" = "--dates" ]; then
    shift 1
    git log --oneline --format=format:"%C(yellow)%h %C(blue)%cr %Creset%s" ${remote}/${remotebranch}.. $@
else
    git log --oneline ${remote}/${remotebranch}.. $@
fi